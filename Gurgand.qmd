---
title: "Gurgand"
author: "Leon Gurgand"
format: html
editor: visual
---

link to the GitHub : https://github.com/LeonG000/grades-eval \## 1.1) Study organisation

### Q1)

```{r}
library(here)
library(ggplot2)
library(vroom)
library(dplyr)
library(tidyr)
library(knitr)
library(readr)
here::i_am("grades-eval.Rproj")
```

```{r}
#|eval: false
courses <- read.csv(here("subject-8","courses.csv"))
```

### Q2)

```{r}
courses_renamed <- courses |>
  rename(
    course = course,
    identifier = course_id,
    module = module,
    number_of_exams = nb_grades
  ) |>
  arrange(course)

kable(courses_renamed)
```

## 1.2) Students

### Q3)

```{r}
students <- read.csv(here("subject-8","students.csv"))
```

```{r}
students <- students |>
  mutate(
    birth_date = as.Date(birth_date), 
    sex = as.factor(sex)
  )
```

```{r}
class(students$birth_date)
class(students$sex)
```

## 1.3) Grades

### Q4)

```{r}
grades_clean <- read_delim(here("subject-8","grades.csv"),
  delim = ":",
  na = "$"
)
```

## 2) Student population analysis

### Q5)

```{r}
ggplot(students, aes(x = factor(group))) +
  geom_bar() +
  labs(
    title = "Number of Students per Group",
    x = "Group",
    y = "Number of Students"
  )
```

### Q6)

```{r}
ggplot(students, aes(x = factor(group), fill = sex)) +
  geom_bar(position = "fill") +
  labs(
    title = "Gender Balance per Group",
    x = "Group",
    y = "Percentage of Students",
    fill = "Gender"
  )
```

### Q7)

```{r}
library(lubridate)
students_age <- students |>
  mutate(age = time_length(today() - birth_date, unit = "year"))

ggplot(students_age, aes(x = age)) +
  geom_histogram(binwidth = 1) +
  labs(
    title = "Distribution of Student Ages",
    x = "Age (years)",
    y = "Number of students"
  )
```

### Q8)

```{r}
median_age_by_group <- students_age |>
  group_by(group) |>
  summarise(median_age = median(age, na.rm = TRUE)) |>
  arrange(group)

kable(median_age_by_group, 
      col.names = c("Group", "Median Age"), 
      caption = "Median Age of Students by Group")
```

### Q9)

```{r}
oldest_per_group <- students_age |>
  group_by(group) |>
  slice_max(age, n = 1, with_ties = FALSE) |>
  ungroup() |>
  select(id, sex, age, group) |>
  arrange(desc(age))

kable(oldest_per_group, 
      col.names = c("ID", "Sex", "Age", "Group"), 
      caption = "Oldest Student in Each Group")
```

## 3) Simple grade analysis

### Q10)

The data set contains `r nrow(grades_clean |> filter(!is.na(grade)))` grades.

### Q11)

```{r}
vr_course_id <- courses |>
  filter(course == "Virtual Reality and Simulated Environments") |>
  pull(course_id)

vr_avg <- grades_clean |>
  filter(course_id == vr_course_id) |>
  inner_join(students, by = "id") |>
  group_by(group) |>
  summarise(avg_grade = mean(grade, na.rm = TRUE)) 

ggplot(vr_avg, aes(x = group, y = avg_grade)) +
  geom_col() +
  labs(
    title = "Average grade in 'Virtual Reality and Simulated Environments' by group",
    x = "Group",
    y = "Average Grade"
  )
```

### Q12)

```{r}
grades_with_module <- grades_clean |>
  inner_join(courses, by = "course_id") |>
  select(id, course_id, grade, module) |>
  filter(!is.na(grade))

ggplot(grades_with_module, aes(x = module, y = grade, fill = as.factor(module))) +
  geom_boxplot() +
  labs(
    title = "Comparison of grade distributions by module",
    x = "Module",
    y = "Grade"
  )
```

## 4) Attendance analysis

### Q13)
```{r}
grades_per_student <- grades_clean |>
  group_by(id) |>
  summarise(nb_grades = n(), .groups = "drop") |>
  inner_join(students |> select(id, group, sex), by = "id")

grades_per_student |>
  slice_head(n = 5) |>
  kable()

summary_table <- grades_per_student |>
  summarise(
    min = min(nb_grades),
    max = max(nb_grades),
    mean = round(mean(nb_grades), 1),
    median = median(nb_grades)
  )
```

### Q14)

```{r}
grades_per_student |>
  ggplot(aes(x = sex, y = nb_grades, fill = sex)) +
  geom_boxplot() +
  labs(
    title = "Distribution of Number of Grades by Sex",
    x = "Sex",
    y = "Number of Grades"
  )
```

### Q15)

```{r}
xeno_course_id <- courses |>
  filter(course == "Xenobiology and Extraterrestrial Life") |>
  pull(course_id)

xeno_grades_per_student <- grades_clean |>
  filter(course_id == xeno_course_id) |>
  group_by(id) |>
  summarise(nb_grades_xeno = n(), .groups = "drop") |>

  left_join(students |> select(id, group), by = "id") |>
  select(id, group, nb_grades_xeno)

xeno_grades_per_student |>
  slice_head(n = 10) |>
  kable()
```

### Q16)

```{r}
xeno_distribution <- xeno_grades_per_student |>
  group_by(nb_grades_xeno) |>
  summarise(n_students = n(), .groups = "drop")

ggplot(xeno_distribution, aes(x = nb_grades_xeno, y = n_students)) +
  geom_col() +
  labs(
    x = "Number of grades in Xenobiology and Extraterrestrial Life",
    y = "Number of students",
    title = "Distribution of number of grades per student"
  )
```

### Q17)

```{r}
ggplot(xeno_grades_per_student, aes(x = factor(nb_grades_xeno), fill = factor(group))) +
  geom_bar(position = "fill") + 
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    x = "Number of grades in Xenobiology and Extraterrestrial Life",
    y = "Percentage of students",
    fill = "Group",
    title = "Proportion of students per number of grades by group"
  )
```

### Q18)

```{r}
xeno_grades_per_student <- xeno_grades_per_student |>
  left_join(students |> select(id, sex), by = "id")

ggplot(xeno_grades_per_student, aes(x = factor(nb_grades_xeno), fill = sex)) +
  geom_bar(position = "dodge") + 
  facet_wrap(~ group) + 
  labs(
    x = "Number of grades in Xenobiology and Extraterrestrial Life",
    y = "Number of students",
    fill = "Sex",
    title = "Number of students by grades, group, and sex"
  )
```

## 5) Grade analysis
### Q19)

```{r}
grades_avg <- grades_clean |>
  group_by(id, course_id) |>
  summarise(avg_grade = mean(grade, na.rm = TRUE), .groups = "drop")

grades_avg <- grades_avg |>
  left_join(students |> select(id, group), by = "id")

grades_avg <- grades_avg |>
  left_join(courses |> select(course, course_id), by = "course_id")

grades_wide <- grades_avg |>
  select(id, group, course, avg_grade) |>
  pivot_wider(names_from = course, values_from = avg_grade)

grades_wide |>
  select(id, group, `Astroengineering and Planetary Colonization`, 
         `Artificial Intelligence and Robotics`) |>
  slice_head(n = 10) |>
  kable()
```

### Q20)

```{r}

xeno_course <- "Xenobiology and Extraterrestrial Life"
vr_course   <- "Virtual Reality and Simulated Environments"

grades_wide <- grades_wide |>
  mutate(
    !!xeno_course := as.numeric(.data[[xeno_course]]),
    !!vr_course   := as.numeric(.data[[vr_course]])
  )

ggplot(grades_wide, aes(x = .data[[xeno_course]], y = .data[[vr_course]])) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "lm", se = FALSE,color = "red") +
  labs(
    x = paste("Average grades in", xeno_course),
    y = paste("Average grades in", vr_course),
    color = "Group",
    title = "Comparison of student averages between Xenobiology and Virtual Reality courses"
  )
```
We observe a positive correlation  between average grades in   Xenobiology and Extraterrestrial Life and in Virtual Reality and Simulated Environments.

### Q21)

```{r}
course_x <- "Cybernetics and Human Augmentation"
course_y <- "Astroengineering and Planetary Colonization"

correlation_by_group <- grades_wide |>
  group_by(group) |>
  summarise(
    correlation = cor(.data[[course_x]], .data[[course_y]], use = "complete.obs"),
    .groups = "drop"
  )

correlation_by_group
```
We observe here also a positive correlation for every group

### Q22)

```{r}
target_group <- correlation_by_group |>
  slice_max(abs(correlation), n = 1) |>
  pull(group)

grades_target_group <- grades_wide |>
  filter(group == target_group)

ggplot(grades_target_group, aes(x = .data[[course_x]], y = .data[[course_y]])) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  labs(
    x = course_x,
    y = course_y,
    title = paste("Average grades for Group", target_group, 
                  "with the strongest correlation")
  )
```

### Q23)

```{r}

final_grades <- grades_wide |>
  rowwise() |> 
  mutate(
    final_grade = mean(c_across(-c(id, group)), na.rm = TRUE)  
  ) |>
  ungroup() |>
  select(id, group, final_grade) |>
  arrange(desc(final_grade)) 

final_grades |>
  slice_head(n = 5)
```

### Q24)

```{r}
grades_by_group <- final_grades |>
  group_by(group) |>
  summarise(
    mean_grade = mean(final_grade, na.rm = TRUE),
    median_grade = median(final_grade, na.rm = TRUE),
    sd_grade = sd(final_grade, na.rm = TRUE),
    n_students = n()
  )
grades_by_group


ggplot(final_grades, aes(x = factor(group), y = final_grade)) +
  geom_boxplot() +
  labs(
    x = "Group",
    y = "Final grade",
    title = "Distribution of final grades by group"
  )
```

### Q25)

```{r}
final_grades <- final_grades |>
  left_join(students |> select(id, sex), by = "id")

summary_including_sex <- final_grades |>
  group_by(group, sex) |>
  summarise(
    n_students = n(),
    mean_grade = mean(final_grade, na.rm = TRUE),
    median_grade = median(final_grade, na.rm = TRUE),
    sd_grade = sd(final_grade, na.rm = TRUE),
    .groups = "drop"
  )

summary_including_sex |> kable() 

ggplot(final_grades, aes(x = factor(group), y = final_grade, fill = sex)) +
  geom_boxplot() +
  labs(
    x = "Group",
    y = "Final Grade",
    title = "Distribution of Final Grades by Group and Sex"
  )
```

### Q26)

```{r}
grades_wide <- grades_wide %>%
  rowwise() %>%
  mutate(final_grade = mean(c_across(-c(id, group)), na.rm = TRUE)) %>%
  ungroup()

module_avg <- grades_wide |>
  pivot_longer(
    cols = -c(id, group),
    names_to = "course",
    values_to = "avg_grade"
  ) |>
  left_join(courses |> select(course, module), by = "course") |>
  group_by(id, group, module) |>
  summarise(module_avg = mean(avg_grade, na.rm = TRUE), .groups = "drop")

module_pass <- module_avg |>
  group_by(id, group) |>
  summarise(all_modules_pass = all(module_avg >= 10), .groups = "drop")

course_pass <- grades_wide |>
  pivot_longer(
    cols = -c(id, group),
    names_to = "course",
    values_to = "avg_grade"
  ) |>
  group_by(id, group) |>
  summarise(all_courses_pass = all(avg_grade >= 5), .groups = "drop")

final_pass <- grades_wide |>
  select(id, group, final_grade) |>
  left_join(module_pass, by = c("id", "group")) |>
  left_join(course_pass, by = c("id", "group")) |>
  mutate(pass = all_modules_pass & all_courses_pass) |>
  select(id, group, final_grade, pass)
```

### Q27
```{r}
final_pass |>
  filter(pass == FALSE & final_grade >= 10) |>
  summarise(n_students = n())
```


